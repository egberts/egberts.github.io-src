Title: Bind9 Keys
Date: 2018-11-13 12:54
Modified: 2022-04-17 10:43
Tags: DNSSEC, DNS, Bind9, TSIG
Category: research
slug: bind9-keys
summary: DNSSEC Keys Used in ISC Bind9

There are several types of crypto keys used by DNS and Bind9.

* Shared Keys
  * TSIG (AFXR/IXFR transfers)
  * Dynamic DNS (DHCP-DNS)
  * RNDC utility
* Public/Private Keys
  * DNSSEC
  * SIG(0)
  * GSS

Note: protect all configuration file(s) having `key` values with 
a UNIX file permission of `u+rw-x,g+r-wx,o-rwx` or `0640`.

```bash
chmod 0750 /var/lib/bind/keys
chmod 0640 /etc/bind/keys/K*+*
chmod 0640 /etc/bind/keys/*/*
```

# TSIG - Shared Key

You can use RFC 2136 "DNS UPDATE", either by scripting the nsupdate tool
or by using a compatible third-party client: Shared secret key (TSIG)

To generate a secret key for authenticating the DNS record updates:

```bash
tsig-keygen -r /dev/urandom | tee tsig-key.private
```
and the output is:
```nginx
key "tsig-key" {
     algorithm hmac-sha256;
     secret "7P6HbRZRJCmtauo/lV0jwN9wkMgBTUikhf9JuaTvYT4=";
  };
```

Copy the printed text into your `named.conf`. (You can have multiple keys
for different hosts, each with a unique name in the key "…" field.)

To enable dynamic updates in a selected zone configuration:

```nginx
  zone "your-dynamic-zone" {
      ...
      update-policy {
          /* grant `<key_name>` `<policy>` `<record_types>` */
          grant "tsig-key" name myserver.example.com ANY;
      };
  };
```
Various different policies can be used; e.g. zonesub allows updating the
entire zone, and subdomain dyn.example.com has the obvious meaning.

To perform DNS record updates:

```bash
nsupdate -k tsig-key.private 
```
The <code>nsupdate</code> goes into interactive mode, execute:
```nsupdate
zone example.com
del myserver.example.com
add myserver.example.com 3600 A 100.64.1.1
send
```

# Dynamic DNS key - Shared Key

There are two ways to create a key for authentication between DHCP server
and DNS name server:

*  `session` key; auto-generated by `named` daemon (key name: `local-ddns`)
*  Manually created key

The plus side of an auto-generated `session` key is nothing
needs to be done and a new key is created each time `named` daemon restarts.  
Downside is that you get the default `hmac-sha256` and you, as an administrator,
must remember to restart DHCP server for everytime that `named` restarts.

If you want `hmac-sha512`, manual key generation is the way to go.  We
could symbolically link the `/etc/bind/rndc.key` into `/etc/dhcp` and
be done here.  But here we are going to create a new key labelled
uniquely apart from the `rndc-key` used by `rndc` utility.

To manually create the key, we can re-use the `named` built-in key 
name, `local-ddns` here.

To use an algorithm better than `hmac-sha256`, we execute:

```bash
rndc-confgen -a -A hmac-sha512 -b 512 local-ddns
# Writes `rndc.key` into /etc/bind
```


# `rndc` - Shared Key

For more details on `rndc` setup, see [Bind9 `rndc` Setup]({filename}dns-bind9-rndc.md)


# DNSSEC - Public/Private Key

For more details on `rndc` setup, see [Bind9 `rndc` Setup]({filename}dns-bind9-rndc.md)


# SIG(0) key

The only place that SIG(0) key is used for is by the ISC Bind9 `nsupdate` utility
in communicating with `named` daemon.

To create one SIG(0) for all the zones in `/var/lib/bind/keys/`, we could; but not here.

Instead, we always want an unique SIG(0) for each `nsupdate` user or for each `nsupdate`/zone.

To generate a public/private pair of SIG(0) keys:

Substitute the `example.test` with your fully-qualified apex part of your domain name (such as `my-personal-domain-that-is-an-example-here.com`, but without any `www.` or `ns`, nor `mail.` part).

```bash
# Go to the zone directory where you want `nsupdate` to have control over

cd /var/lib/bind/keys/example.test/

dnssec-keygen \
    -T KEY \
    -n USER \
    -a ECDSAP384SHA384 \
    example.test
ls K*
```
outputs an example of a directory list below:
```ls
Kexample.test.+014+99999.key
Kexample.test.+014+99999.private
```

The \*.key file contains the public key – add it to your DNS zone.

The \*.private file contains the private key – copy it to the client
computer. (Actually, copy both files to the client computer.)

Set up update-policy { } in exactly the same way as with TSIG.

Perform updates also in the same way using:
```bash
nsupdate -k <filename>.private
```

<!-- (Note: While TSIG key names are arbitrary, SIG(0) keys are stored in DNS
zone data file and therefore always use the fully-qualified name of 
hostnames/subdomains. (???)

Although, the key name itself does not need to match the hostname. -->


# Kerberos (GSS-TSIG) key

A bit out of scope here, but BIND9 supports this as well (mainly for use with
Windows Active Directory servers).
