title: Exim4 reads for config files
date: 2022-03-25 07:44
status: published
tags: Exim4
category: research
summary: What does Exim4 read for configuration files in Debian Split-Configuration mode? Debian Standalone mode?  Exim4 mode?
slug: exim4-config-check-which
lang: en
private: False


This article details which configuration files that Exim4 daemon reads in various modes:

* Exim4-only
* Debian Standalone 
* Debian Split-File

I determined this by this doing this [exim4-config-check-which](https://github.com/egberts/exim4-config-check-which) bash script on Github.


I have evaluated version 4.95.4 of Exim4.

The reading ordering of files by Exim4 for all config modes are:

3. `/etc/mailname`
4. `/etc/exim4/update-exim4.conf.conf` (read)


How I Analyzed It
=================
My first go-to tool for determining "who is opening what file" analysis is `strace -f` but there is some scripting language to consider ... firstly.  We can do this using `file` command against the mystery `update-exim4.conf` file to determine if that file is a script or not.

```console
$ file "$(which update-exim4.conf)"
/usr/sbin/update-exim4.conf: POSIX shell script, ASCII text executable
```
The `update-exim4.conf` is a POSIX bash shell, so let us use `bash -x` to expand what the script is doing as well.

    bash -x /usr/sbin/update-exim4.conf

Output looks like this:
```console
#     bash -x /usr/sbin/update-exim4.conf
+ set -e
+ set -C
+ set -f
+ UPEX4C_confdir=/etc/exim4
+ UPEX4C_sections='main acl router transport retry rewrite auth'
+ UPEX4C_semicolon='dc_local_interfaces dc_relay_nets dc_relay_domains'
+ EXIM=/usr/sbin/exim4
+ UPEX4C_verbose=no
+ UPEX4C_autoconfigfile=/var/lib/exim4/config.autogenerated
+ UPEX4C_outputfile=/var/lib/exim4/config.autogenerated
+ UPEX4C_version=4.94.2-7
++ getopt -n update-exim4.conf -l check,keepcomments,removecomments,output:,confdir:,help,verbose -- +o:d:vh
+ TEMP=' --'
+ test 0 '!=' 0
+ eval set -- --
++ set -- --
+ test -- '!=' --
+ shift
+ '[' 0 -ne 0 ']'
+ '[' -e /etc/exim4/exim4.conf ']'
+ UE4CC=/etc/exim4/update-exim4.conf.conf
+ UPEX4C_confd=/etc/exim4/conf.d
++ dirname /var/lib/exim4/config.autogenerated
+ '[' -d /var/lib/exim4 ']'
+ '[' -f /etc/exim4/update-exim4.conf.conf ']'
+ . /etc/exim4/update-exim4.conf.conf
++ dc_eximconfig_configtype=internet
++ dc_other_hostnames=egbert.net
++ dc_local_interfaces='127.0.0.0 ; ::1 ; 104.218.48.116 ; 2604:a00:5:1156::116'
++ dc_readhost=
++ dc_relay_domains=
++ dc_minimaldns=false
++ dc_relay_nets=
++ dc_smarthost=
++ CFILEMODE=640
++ dc_use_split_config=true
++ dc_hide_mailname=
++ dc_mailname_in_oh=true
++ dc_localdelivery=mail_spool
++ dc_local_part='*- : *+ : *_'
++ dc_main_tls_certificate=/etc/exim/keys/cert.pem
++ dc_main_tls_privatekey=/etc/exim/keys/privkey.pem

... \< snip snip \>

+ /usr/sbin/exim4 -C /var/lib/exim4/config.autogenerated.tmp -bV
+ '[' x = xyes ']'
+ mv -f /var/lib/exim4/config.autogenerated.tmp /var/lib/exim4/config.autogenerated
+ chmod 640 /var/lib/exim4/config.autogenerated
```

To interleave the `bash -x` output with the `strace -f`, we UNIX-pipe these two commands together.

```console
strace -f bash -x /usr/sbin/update-exim4.conf
```

The output would be monstrously long.  But `strace` has its own filtering options.

We could make `strace`look for all things related to both `process` and `file`.

Even narrow down the list of functions to just our selected `file`-related functions as well as all things related to `process` during `strace`:

```bash
strace -f -v -s 80 \
  -e trace=process,\
open,openat,read,write,\
connect,accept,access,renameat2,\
statfs,stat,newfstatat \
  bash -x /usr/sbin/update-exim4.conf \
    > /tmp/update-exim4.conf.strace 2>&1 
```

Also, we can eliminate certain commands used by `bash` like `rm` or `dirname` or things like that as we are only interested in which files got open, read, or write.

```console
$ cat /tmp/update-exim4.conf.strace | grep -v "fstat" | \
    grep -E "(open|stat|exec|write|wr)" \
       | grep -v "/x86_64" | grep -v "passwd" | grep -v group \
       | grep -v "ld.so.cache" | grep -v "SIG" | grep -v "/local" \
       | grep -v "/sed" | grep -v "/tr" | grep -v "/getop" \
       | grep -v "/dirname" | grep -v "resumed" | grep -v "/cat\"" \
       | grep -v "/selinux" | grep -v "/grep" | grep -v "/proc" \
       | grep -v "/rm\"" | grep -v "/null\"" | grep -v "nsswitch" \
       | grep -v "/mv\"" | grep -v "/touch" | grep -v "/id\"" \
       | grep -v "/chown" | grep -v "/ls\"" | grep -v "/chmod" \
       | grep -v "/expr" | less
```
Output is a bit smaller but still monstrously long.


For the Debian Standalone setup mode of config files, I have hand-compiled the list as:

```
bash-execute /usr/sbin/update-exim4.conf
open/read    /etc/exim4/update-exim4.conf.conf
open/read    /etc/mailname
open/WRITE   /var/lib/exim4/config.autogenerated.tmp
open/read    /etc/exim4/exim4.conf.localmacros
open/read    /etc/exim4/exim4.conf.template
mv           /var/lib/exim4/config.autogenerated
```

Same for Debian Split-File mode of config files, the short-version is:
```
bash-execute /usr/sbin/update-exim4.conf
open/read    /etc/exim4/update-exim4.conf.conf
open/read    /etc/mailname
open/WRITE   /var/lib/exim4/config.autogenerated.tmp
open/read    /etc/exim4/conf.d/main/*
open/read    /etc/exim4/conf.d/acl/*
open/read    /etc/exim4/conf.d/router/*
open/read    /etc/exim4/conf.d/retry/*
open/read    /etc/exim4/conf.d/rewrite/*
open/read    /etc/exim4/conf.d/auth/*
open/read    /etc/exim4/conf.d*
mv           /var/lib/exim4/config.autogenerated
```

Noticed that in split-config, following files are being IGNORED?

* /etc/exim4/exim4.conf.localmacros
* /etc/exim4/exim4.conf.template

But in standalone config, these files are being IGNORED?

* /etc/exim4/conf.d
* /etc/exim4/conf.d/*
* /etc/exim4/conf.d/*/*


Recap, each Exim4 config mode uses the following files:

| file | Debian config mode |
|---|---|
| `/etc/exim4/exim4.conf` | non-Debian-only |
| `/etc/exim4/exim4.conf.localmacros` | standalone |
| `/etc/exim4/exim4.conf.template` | standalone |
| `/etc/exim4/conf.d/*` | split-mode |
| `/etc/exim4/conf.d/*/*` | split-mode |
| `/var/lib/exim4/config.autogenerated` | all |


