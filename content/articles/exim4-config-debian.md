title: Many Ways of Debian Config for Exim4 Mail Server
date: 2022-03-26 11:45
status: published
tags: Exim4, Debian
category: HOWTO
summary: Details the many ways that one can set up the Exim4 Mail Server for Debian.
slug: exim4-config-debian.md
lang: en
private: False

This article is lengthy but explains how Debian configuration are being used by Exim4 mail server.

Exim4 is a mail server.  It is arguable the fastest rising ones in popularity against the three (Postfix, Sendmail, OpenSMTPD).

# TL;DR:

Depending on your Debian configuration mode selected, the Exim4 settings goes into this file:

| Debian config mode | where are my settings go into? |
| --- | --- |
| Exim4 (non-Debian) | `/etc/exim4/exim4.conf` |
| Standalone | `/etc/exim4/exim4.conf.localmacros` |
| Split File | `/etc/exim4/conf.d/main/00-my-settings-go-here` |
<p></p>
Always run `update-exim4.conf` (except in pure Exim4 mode).

# And So It Begins

Exim4 daemon reads all of its settings from the `/etc/exim4/exim4.conf` configuration file.  Been that way for a long time.

Single config file.  Nice and neat.   Until it started balloning to more than 200 settings with complex subnesting formatting. Borrowed many traits from Sendmail (of which I am a Sendmail expert).

Imagine the group of reconfigurator tools (Webmin, Debian, Roundcube, etc.) trying to simplify things for end-users (like blogger, webmaster, anyone who is clueless in SMTP protocol).   Imagine the struggling to keep up with massive set of settings in the config file.   Complex syntax, so complex enough that editing of its single LARGE config file, has been known to make a Bash programmer cry.

Nevermind the veteran mail administrators carefully making individual changes but losing their place within the chronological ordering within that lone (but LARGE) config file.  

Argh!

Debain maintainers has attempted to conquer all of these Exim4 settings by grouping these settings into smaller but multiple config files.  

Smaller files makes it easier for us (and reconfigurator tools) to change or add or even delete settings. Their attempts at this grouping is so success and simple; the following groups are:

1. acl
2. auth
3. main
4. retry
5. rewrite
6. router
7. transport

Why did Debian maintainers do this?  It paves the way for easier and safer working with settings not only by us but by tools as well.

Tools, packagers, and installers (like DKIM, DMARC, AV, Anti-Spam) can now insert their own settings into Exim4 at the right ordering without interfering with its neighborhood files.

The name of each subdirectory make it easier for us to "think" where we are at while we make the settings in each.  Named directory covers each functional aspect of SMTP protocol.

# Subdirectory Settings

Some of you may recall other packages using config subdirectories to group settings apart, such as OpenSSH.

This subdirectory of config settings is NOT a new concept (others like ISC Bind9 named/dhcpd, systemd, nginx, lighttpd do this too).

For the last 5 years, Exim4 can read an alternative config file from `/var/lib/exim4/config.autogenerated`, in case secondary secondary secondary the missing `exim4.conf`.  
Missing `exim.conf` file is this primary mechanism to say "Debian's the way".  It bears repeating because its man page (as currently written) will do word gymnastic on you.

The missing of a `exim4.conf` file means the `exim4` daemon (on Debian distro) will read its settings from the `/var/lib/exim4/config.autogenerated` file instead.  IMHO, this filename could have been named better, perhaps like `exim4.conf.autogenerated` so that we all can intuitively tell that this is still related to `exim4.conf` but "auto-generated".

# Daemon Configuration File

In summary, there are two ways for Debian-tweaked `exim4` daemon to read a configuration file:

* `/etc/exim4/exim4.conf`, if not exist then
* `/var/lib/exim4/config.autogenerated`

There can only be one.  (Sorry, Highlander)

# Debian Auto Generation 

With the `exim4.conf` file deleted (or renamed out of the way), its Debian-time!

There are several tools that generate this `config.autogenerated` file on a Debian server:

[jtable]
tool, description
`apt install exim4-config`, a Debian package installer that takes user-specific settings ONCE then calls the tool below; done ONCE during installation time.  May not prompt for user inputs if `apt install --reinstall` is done (depends if `--purge` option is given during `apt remove` before any installation)
`dpkg-reconfigure exim4-config`, an installer configuration prompting tool that takes user-specific settings then calls the tool below; done during reconfiguration or `apt upgrade`.
`update-exim4.conf`, a bash script that merges Exim4 settings into the `config.autogenerated` file.
[/jtable]

These tools over-writes this `config.autogenerated` file pretty much always, barring any fickle conditions (such as missing exim4.conf).


# Exim4 Settings, Debian-way

The `exim4.conf` is gone but, But, ... BUT there are many config files in `/etc/exim4`.  And the Exim4 daemon reads from a faraway `/var/lib/exim4` directory; what gives?

Exim settings all start within the `/etc/exim4` directory; this is where you do all your tweaking in ... within.

And a tool reads all your `/etc/exim4` settings and generates that final `config.autogenerated` file ... to be stored far away from this `/etc/exim4`.  Not the most ideal way to do this.

NOTE: OpenSSH, named, dhcpd, NTPd, and chronyd has the `include` file statement that can be used within its config file to do the heavy merging of settings; Debian-Exim4 does not and requires an extra tooling to do the merging of settings.  

NOTE: I am assuming of the Debian maintainers that there is some kind of dynamic situation of a host that would call for the live changing of settings which would require a `/var` directory to hold these 'dynamic' settings of Exim4, but then again they are now storing these original but dynamic setting into LFSS-static `/etc` directory, so that alone is a violation of Linux File System Standard v1.2 (not to mention that `etckeeper` does a git-saving of `/etc` will be going wild with excessive git-logging).  If such dynamic Exim4 settings is required, it should have gone into `/var/lib/exim4` or `/var/run/exim4` (depending on need to survive across host reboots), and not in the `/etc/exim4`.  Dynamic scenarios that I could think of would be a dynamic IP address, a live-gating of a smarthost, VPN tunnel UP/DOWN, interface changeover due to route change (dual-homed, RIP, BGP, OSPF, EGP), host-to-host failover, virtual routing redundancy protocol (VRRP), etc..

This extra tooling to do merging of settings is called `updated-exim4.conf`.   No, it is not a name of the config file, but an executable; yeah, I know, I know, not quite an intuitive filename.

NOTE: `update-exim4.conf.conf` is a config file for this `update-exim4.conf` tool; oh yeah, again, not an intuitive filename either.

Recap:

[jtable]
file, description
`update-exim4.conf`, a bash script that merges Exim4 settings into `/var/lib/exim4/config.autogenerated` config file.
`update-exim4.conf.conf`, a config file for its corresponding tool
[/jtable]


## Gathering of Settings

Let us go back to `/etc/exim4` and stay there.

There are two different ways to set up these Exim4 config settings:

* standalone Debian config file (again, Debian-related, but not the final config)
* split-file Debian subdirectories.

I've asked this question before: 

   Q: What is the different between the standalone Debian 
      and the original `exim4.conf`?

   A: The introduction of Debian-specific if-then-else-endif logic.

Now this is all starting to make sense: they layered a Debian-specific IF-THEN-ELSE-ENDIF logic on top of the original layer of Exim4-specific IF-THEN-ELSE-ENDIF.  

This is the golden mechanism for setting up any rapid configuration (and really puts Ansible/Puppet/Chef, which attempted to do the same for Exim4, to shame).  In short, Debian did all the hard work of grouping the settings together (like Exim4, sendmail and Postfix should have done in the first place).

The Debian-specific layer is using all-CAPITALIZED variable names whereas Exim4-specific settings are in all-lowercase.  Again, that's:

[jtable]
variable name case, layering scope
all-CAPITALIZED, represents the Debian-specific variable name used for Debian-related settings and by Debian/Exim4 logics found within Exim4 config files.
`dc_` prefix, Only by Debian Package [Re-]Configurator
all-lowercase, represents the Exim4-specific variable name used for Exim4-related settings and by Exim4 logics found in Exim4 config files.
[/jtable]

## Wait a Minute; What is `dc_`

To complicate things a bit further, Debian reserved the `dc_` variable name prefix to represent `dpkg-reconfigure`-specific settings obtained through its user interface prompting.

`dc_` prefix is meant to be used only by `dpkg-reconfigure exim4-config` and related `apt install exim4-config` commands.  

For my own settings, I'd just stay away from the `dc_` and stick with the all capitalied ones; unless one cannot be found within the existing config files, then I proceed to use Exim4 settings directly.  This way, one can insulate themselves from future Debian upgrades almost completely.

# Initial Setup
At installation/reconfiguration time, we get the:
```bash
dpkg-reconfigure exim4-config
```
and a series of questions taking our selection for our choice of 4 canned Exim4 setups.

For most scenarios, that is it; we're done; for Internet-only servers, not so much.


# Settings Complexity & Shortfalls

Recapping complexity here, there are currently several ways to configure Exim4 daemon and it is by using one of the followings:

* 200+ individual settings of `/etc/exim4/exim4.conf`  (expert)
* 9 to 15 settings of `/etc/exim4/update-exim4.conf.conf` and let Debain reconfigurator take care of the rest.  (beginner)
* Several subdirectories whose directory are named by its email function. (novice)
  * each function directory contains files having individual or group settings

Of the four options provided by Debian `dpkg-reconfigure`, only Internet Server option remains ... incomplete.

Internet Server option is STILL missing those DKIM, DMARC, SPF, TLS, hardening, SpamAssassin, ClamAV amongst many things needed for a stable email server.


# Debian Config Files Layout

Given the incompleteness of Internet Server option, we still have to decide WHICH way to setup the config files to hold our intensive settings (for the missing pieces).

We could plunge ahead in the old ways of maintaining a singular LARGE Exim4 config file.  Keep in mind, a mistake may not be found ... easily, even under daemon debugging mode.  And believe me, mistakes are made ... easily.  And no, `etckeeper` tool will not save you.

My advice is to delete the `/etc/exim4/exim4.conf` file and you start using Debian config files.  Debian package default is not to install the `exim4.conf` file.

And again for the same reasons given, the Debian standalone option of using a singular large option files shall not be used either; a split-file method, it is going to be.

To use split-file approach, we edit the `/etc/exim4/update-exim4.conf.conf` file
and change the `dc_use_split_config` setting to `true`:

```ini
...
dc_use_split_config = 'true'
...
```

My bet is that this variable has already been set to `true` for that's the Debian package default.



# Executable Tools
* `update-exim4.conf` (split-file only)
* `update-exim4.conf.template`  (split-file back to single-config)
* `dpkg-reconfigure exim4-config`  (upgrade, installation)

# `conf.d/` File Naming Convention

While not clearly detailed, the file name of setting files is sensitive to uptake by the `update-exim4.conf` tool:

* Only accepts characters of filename within A-Z, a-z, 1-9, underscore and hyphen.
* accepts files with `.rul` filetype (only one with a period, discontinued, legacy Exim3)
* period ('`.`') symbol not accepted (except for `.rul`).

In short, keep config files simple using `[-_A-Za-z0-9]` pattern.

# `conf.d` Reading Order

The ordering 

# `conf.d`/ files

Under the `/etc/exim4/conf.d`, there are five subdirectories.  These subdirectories hold config files containing a one or few settings.

# Summary

I do not know why the Exim upstream are hard up on not supporting multi-file config approach which would totally obviate the need for extra Debian maintainer overhead and completely discharge this entire article.  

Until then, Exim4 is in for a hard road in adoption rate.  
